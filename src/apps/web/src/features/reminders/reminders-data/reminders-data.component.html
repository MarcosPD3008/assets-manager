<div class="reminders-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Gestión de recordatorios</mat-card-title>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="navigateToCreate()">
          <mat-icon>add</mat-icon>
          Nuevo recordatorio
        </button>
      </div>
    </mat-card-header>

    <mat-card-content>
      <mat-accordion class="filters-accordion">
        <mat-expansion-panel
          [expanded]="filtersExpanded"
          (opened)="filtersExpanded = true"
          (closed)="filtersExpanded = false"
        >
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>filter_list</mat-icon>
              Filtros
            </mat-panel-title>
            <mat-panel-description>
              {{ filtersExpanded ? '' : 'Expandir para filtrar' }}
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="filters-grid">
            <mat-form-field appearance="outline">
              <mat-label>Estado</mat-label>
              <mat-select [(ngModel)]="filters.status">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let status of reminderStatuses" [value]="status">
                  {{ getStatusLabel(status) }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Tipo</mat-label>
              <mat-select [(ngModel)]="filters.type">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let type of reminderTypes" [value]="type">
                  {{ type === 'ASSIGNMENT' ? 'Asignación' : 'Mantenimiento' }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Origen</mat-label>
              <mat-select [(ngModel)]="filters.sourceType">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let source of reminderSources" [value]="source">
                  {{ getSourceTypeLabel(source) }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-action-row>
            <button mat-button (click)="clearFilters()">
              <mat-icon>clear</mat-icon>
              Limpiar
            </button>
            <button mat-raised-button color="primary" (click)="applyFilters()">
              <mat-icon>search</mat-icon>
              Aplicar filtros
            </button>
          </mat-action-row>
        </mat-expansion-panel>
      </mat-accordion>

      <div class="table-container" *ngIf="!loading">
        <table mat-table [dataSource]="reminders" class="reminders-table">
          <ng-container matColumnDef="message">
            <th mat-header-cell *matHeaderCellDef>Mensaje</th>
            <td mat-cell *matCellDef="let reminder">{{ reminder.message }}</td>
          </ng-container>

          <ng-container matColumnDef="scheduledDate">
            <th mat-header-cell *matHeaderCellDef>Fecha programada</th>
            <td mat-cell *matCellDef="let reminder">
              {{ reminder.scheduledDate | date : 'dd/MM/yyyy HH:mm' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Tipo</th>
            <td mat-cell *matCellDef="let reminder">
              {{ reminder.type === 'ASSIGNMENT' ? 'Asignación' : 'Mantenimiento' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="priority">
            <th mat-header-cell *matHeaderCellDef>Prioridad</th>
            <td mat-cell *matCellDef="let reminder">
              <mat-chip [style.background-color]="getPriorityColor(reminder.priority)" selected>
                {{ getPriorityLabel(reminder.priority) }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="channel">
            <th mat-header-cell *matHeaderCellDef>Canal</th>
            <td mat-cell *matCellDef="let reminder">{{ getChannelLabel(reminder.channel) }}</td>
          </ng-container>

          <ng-container matColumnDef="sourceType">
            <th mat-header-cell *matHeaderCellDef>Origen</th>
            <td mat-cell *matCellDef="let reminder">
              {{ getSourceTypeLabel(reminder.sourceType) }}
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let reminder">
              <span [class]="getStatusClass(reminder.status)">
                {{ getStatusLabel(reminder.status) }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let reminder">
              <button mat-icon-button [matMenuTriggerFor]="actionsMenu">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #actionsMenu="matMenu">
                <button mat-menu-item (click)="navigateToView(reminder)">
                  <mat-icon>visibility</mat-icon>
                  <span>Ver detalle</span>
                </button>
                <button mat-menu-item (click)="navigateToEdit(reminder)" *ngIf="canMarkAsSent(reminder)">
                  <mat-icon>edit</mat-icon>
                  <span>Editar</span>
                </button>
                <button mat-menu-item *ngIf="canMarkAsSent(reminder)" (click)="markAsSent(reminder)">
                  <mat-icon>check_circle</mat-icon>
                  <span>Marcar como enviado</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [attr.colspan]="displayedColumns.length">
              <div class="no-data">
                <mat-icon>notifications_off</mat-icon>
                <p>No se encontraron recordatorios</p>
              </div>
            </td>
          </tr>
        </table>
      </div>

      <div class="loading-container" *ngIf="loading">
        <mat-spinner></mat-spinner>
        <p>Cargando recordatorios...</p>
      </div>

      <app-pagination
        *ngIf="!loading"
        [total]="total"
        [page]="page"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        (pageChange)="onPageChange($event)"
        (pageSizeChange)="onPageSizeChange($event)"
      >
      </app-pagination>
    </mat-card-content>
  </mat-card>
</div>
